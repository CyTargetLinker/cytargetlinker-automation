---
title: '[CTL] Gene - Pathway Extension'
author: "mkutmon"
date: "April 15, 2018"
output: html_document
---

*Part of this script are based on information / examples provided on in https://github.com/cytoscape/cytoscape-automation* 

## Step 0: Set up environment

### Install RCy3
Tested with RCy3 version 2.0.1 in R v3.5.0
```{r setup, include=FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite("RCy3")
library(RCy3)
```

### Set working directory
```{r set working directory}
#install.packages("knitr")
library(knitr)
knitr:::input_dir()
```

### Test connection to Cytoscape and installed apps
```{r test connection}
cytoscapePing()

if("string" %in% commandsHelp("")) print("Success: the STRING app is installed") else print("Warning: STRING app is not installed. Please install the STRING app before proceeding.")
if("cytargetlinker" %in% commandsHelp("")) print("Success: the CyTargetLinker app is installed") else print("Warning: CyTargetLinker app is not installed. Please install the CyTargetLinker app before proceeding.")
```

*** 

## Step 1: Loading list of DEG genes
Import the differentially expressed genes in Cytoscape

**If the STRING app is not installed, no error is reported, but your network  will be empty**
```{r}
degs <- file.path(getwd(), "Data", "DEGs.xlsx")
import.cmd = paste('network import file file="',degs,'" indexColumnSourceInteraction=1 firstRowAsColumnNames=true startLoadRow=1', sep="")
commandsRun(import.cmd)
```

![](https://github.com/CyTargetLinker/cytargetlinker-tutorials/blob/master/R/UseCase2/Figures/step1.png){height=100%}

*** 

## Step 2: Extend network with pathway information

**If the CyTargetLinker app is not installed, no error is reported, but your network  will not be extended**

**Load Linksets**
LinkSets can be downloaded from the CyTargetLinker website https://projects.bigcat.unimaas.nl/cytargetlinker/linksets/ and preprocessed as R objects. 
 
* WikiPathways for curated mouse pathway collection

### Extend the network with protein-compound interactions from ChEMBL
Possible seetings for direction: SOURCES (add only source nodes), TARGETS (add only target nodes) and BOTH (default)
```{r}
wp <- file.path(getwd(), "LinkSets", "wikipathways-mm-20180410.xgmml")
CTLextend.cmd = paste('cytargetlinker extend idAttribute="shared name" linkSetFiles="', wp, '" network=current direction=SOURCES', sep="")
commandsRun(CTLextend.cmd)
```

### Apply a force-directed layout to the network
```{r}
CTLlayout.cmd = 'cytargetlinker applyLayout network=current'
commandsRun(CTLlayout.cmd)
```

### Filter genes with pathway associations:
```{r}
filter1.cmd = "network select edgeList=all"
filter2.cmd = "network select extendEdges=true"
filter3.cmd = "network create nodeList=selected edgeList=selected networkName=selection source=current"

commandsRun(filter1.cmd)
commandsRun(filter2.cmd)
commandsRun(filter3.cmd)

```

### Load data for genes and pathways
```{r}
degs <- file.path(getwd(), "Data", "DEGs.xlsx")
import.table1.cmd = paste('table import file file="',degs,'"  KeyColumnForMappingNetworkList="shared name" keyColumnIndex=1 startLoadRow=1 firstRowAsColumnNames=true', sep="")
commandsRun(import.table1.cmd)

p <- file.path(getwd(), "Data", "PathwayStatistics.xlsx")
import.table2.cmd = paste('table import file file="', p, '"  KeyColumnForMapping=CTL.PathwayName keyColumnIndex=1 startLoadRow=1 firstRowAsColumnNames=true', sep="")
commandsRun(import.table2.cmd)

```

### Apply specific style for compound-disease networks
```{r}
vizstyle.file <- file.path(getwd(), "VizStyles", "viz-style-usecase2.xml")
LoadStyle.cmd = paste('vizmap load file file="',vizstyle.file,'"', sep="")
commandsRun(LoadStyle.cmd)

ApplyStyle.cmd = 'vizmap apply styles="CTL Gene Pathway Network"'
commandsRun(ApplyStyle.cmd)
```
![](https://github.com/CyTargetLinker/cytargetlinker-tutorials/blob/master/R/UseCase2/Figures/step2.png){height=100%}

*** 

## Step 3: Saving, sharing and publishing

### Saving a Cytoscape session file
Session files save *everything*. As with most project software, we recommend saving often!
```{r}
session.file <- file.path(getwd(), "Results", "DEGs_Pathway_Network.cys")
saveSession(session.file) #.cys
```

### Exporting high resolution image files
You can export extremely high resolution images, including vector graphic formats.
```{r}
pdf.file <- file.path(getwd(), "Results", "DEGs_Pathway_Network.pdf")
exportImage(pdf.file,'PDF')
png.file <- file.path(getwd(), "Results", "DEGs_Pathway_Network.png")
exportImage(png.file,'PNG')
```

### Exporting interactive web pages via cytoscape.js
You can export the network model in multiple standard formats. And if you want to get really fancy, you can export the model and style in cytoscape.js formats and host interactive views of your network analysis and visualization results online!
```{r}
cyjs.file <- file.path(getwd(), "Results", "DEGs_Pathway_Network.cyjs")
exportNetwork(cyjs.file,'CYJS')  #.cyjs
json.file <- file.path(getwd(), "Results", "DEGs_Pathway_Network.json")
exportStyle(json.file,'json')
```

More details in Cytoscape manual chapter on [Interactive Web Applications](http://manual.cytoscape.org/en/stable/Export_Your_Data.html#as-an-interactive-web-application-new-in-3-2-0)


And in Cytoscape, you can File>Export as Web Page... to produce a folder of cytoscape.js files and html.